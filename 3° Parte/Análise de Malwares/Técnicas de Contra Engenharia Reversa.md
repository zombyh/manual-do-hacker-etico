## Resumo: T√©cnicas de Contra Engenharia Reversa

## üìå Vis√£o Geral
- **Disciplina**: An√°lise de Malwares  
- **Aula**: 7 ‚Äì Contra Engenharia Reversa  
- **Objetivos**:
  - Identificar t√©cnicas de **anti-desmontagem**.
  - Identificar t√©cnicas de **anti-depura√ß√£o**.
  - Reconhecer caracter√≠sticas de **empacotadores**.

---

## üõ°Ô∏è Anti-Desmontagem

### O que √©?
- T√©cnica que insere c√≥digos ou dados para **confundir ferramentas de desmontagem**, atrasando ou impedindo a an√°lise.

### Como funciona?
- Aproveita **suposi√ß√µes e limita√ß√µes** dos desmontadores.
- Exemplo: deslocar a execu√ß√£o em **1 byte** para causar desalinhamento na leitura do c√≥digo.

### Tipos de Desmontagem

| Tipo | Descri√ß√£o | Exemplo de Ferramenta |
|------|------------|------------------------|
| **Linear** | Desmonta instru√ß√µes em sequ√™ncia, sem considerar fluxo. | Depuradores simples |
| **Orientada a Fluxo** | Considera ramifica√ß√µes e execu√ß√£o real. | IDA Pro |

### Exemplo Pr√°tico
- Dois desmontadores podem exibir **conjuntos de instru√ß√µes diferentes** para o mesmo c√≥digo.
- Uso de **jumps condicionais consecutivos** para o mesmo alvo pode enganar o desmontador.

> üí° **Dica**: Use desmontadores orientados a fluxo para maior precis√£o.

---

## üîç Anti-Depura√ß√£o

### O que √©?
- T√©cnica para **detectar ou impedir** a execu√ß√£o controlada por um depurador.

### T√©cnicas Comuns

#### 1. Chamadas do Windows
- **`IsDebuggerPresent`**: Verifica campo `IsDebugged` na estrutura PEB.
- **`CheckRemoteDebuggerPresent`**: Similar √† anterior, mas pode verificar outros processos.
- **`NtQueryInformationProcess`**: Consulta informa√ß√µes do processo, como a porta de depura√ß√£o.

#### 2. Verifica√ß√µes Manuais
- Inspe√ß√£o de **estruturas PEB**.
- Busca por **chaves de registro** (ex: `AeDebug`).
- Varredura por **processos, arquivos ou janelas** de depuradores.

#### 3. Detec√ß√£o de Breakpoints
- Varredura por **opcode `0xCC`** (INT 3) no c√≥digo.

#### 4. Verifica√ß√µes de Tempo
- Compara√ß√£o de **timestamps** antes e depois de opera√ß√µes ou exce√ß√µes.
- Execu√ß√£o mais lenta sob depura√ß√£o ‚Üí indica presen√ßa de depurador.

### Como Contornar?
- Modificar flags ou instru√ß√µes durante a execu√ß√£o.
- Usar hooks em fun√ß√µes de detec√ß√£o.
- Ignorar exce√ß√µes automaticamente no depurador.

---

## üñ•Ô∏è Anti-M√°quina Virtual (Anti-VM)

### Objetivo
- Impedir an√°lise em ambientes virtualizados (ex: VMware, VirtualBox).

### T√©cnicas de Detec√ß√£o

#### 1. Processos e Servi√ßos
- Busca por processos como `vmtoolsd.exe` ou `VGAuthService.exe`.
- Comando:  
  ```cmd
  net start | findstr VMware
  ```

#### 2. Registro do Windows
- Chaves com refer√™ncias a `VMware` no registro.

#### 3. Hardware
- Endere√ßo MAC come√ßa com `00:0C:29`.
- Identificador de disco cont√©m "VMware".

#### 4. Mem√≥ria
- Estruturas de mem√≥ria alteradas pela virtualiza√ß√£o.

### Como Evitar?
- Desinstalar ferramentas de VM (ex: VMware Tools).
- Usar VMs sem assinaturas t√≠picas.
- Alternar entre diferentes hipervisores.

---

## üì¶ Empacotadores (Packers)

### O que s√£o?
- Ferramentas que **compactam, criptografam ou modificam** execut√°veis para dificultar a an√°lise.

### Caracter√≠sticas
- F√°ceis de usar, muitas vezes gratuitos e de c√≥digo aberto.
- Inutilizam a **an√°lise est√°tica**.

### Funcionamento
1. **Entrada**: Execut√°vel original.
2. **Processo**: Compacta√ß√£o/criptografia.
3. **Sa√≠da**: Novo execut√°vel com:
   - Rotina de desempacotamento.
   - C√≥digo original empacotado.

### Etapas da Rotina de Desempacotamento
1. Desempacota o execut√°vel na mem√≥ria.
2. Resolve importa√ß√µes.
3. Transfere execu√ß√£o para o ponto de entrada original.

### Sinais de Empacotamento
- Poucas importa√ß√µes (ex: s√≥ `LoadLibrary` e `GetProcAddress`).
- Se√ß√µes com tamanhos anormais.
- Nomes de se√ß√£o suspeitos (ex: `UPX0`).
- Alta entropia (dados parecem aleat√≥rios).

### Ferramentas de Apoio
- **PEiD**: Identifica empacotadores.
- **Entropia**: Mede aleatoriedade dos dados.

### Desempacotamento
- **Est√°tico**: Usando ferramentas espec√≠ficas (ex: UPX unpacker).
- **Din√¢mico/Manual**: Via depura√ß√£o ‚Äì mais comum para malwares complexos.

---

## üìö Refer√™ncias
- Sikorski, M.; Honig, A. ‚Äì *Practical Malware Analysis*
- Anley, C. ‚Äì *The Shellcoder‚Äôs Handbook*
- Tanenbaum, A.S. ‚Äì *Organiza√ß√£o Estruturada de Computadores*

---
