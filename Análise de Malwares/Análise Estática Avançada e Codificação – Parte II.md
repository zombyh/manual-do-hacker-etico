
## 📘 Resumo: Análise Estática Avançada e Codificação – Parte II

### 📌 Objetivos da Aula
- Identificar chamadas de funções e passagem de parâmetros em Assembly.
- Utilizar o IDA Pro para análise estática de binários.
- Relacionar estruturas de código em C com sua representação em Assembly.

---

## 🧩 Funções em Assembly

### 🔁 O que são funções?
- Blocos de código que executam uma tarefa específica.
- Relativamente independentes do restante do programa.
- Chamadas pelo código principal via instrução `call`.

### 🧱 Estrutura de uma Função
1. **Prólogo**:  
   - `push ebp`  
   - `mov ebp, esp`  
   - Aloca espaço na pilha para variáveis locais.

2. **Corpo**:  
   - Execução da lógica da função.

3. **Epílogo**:  
   - `pop ebp`  
   - `ret`  
   - Restaura a pilha e retorna ao chamador.

### 📤 Passagem de Parâmetros
- Parâmetros são passados via **pilha** (instruções `push` ou `mov`).
- Convenção de chamada define a ordem e a limpeza da pilha.

---

## 🛠️ IDA Pro: Ferramenta de Desmontagem

### 📥 Carregamento de Arquivos
- Reconhece automaticamente formatos: PE (Windows), ELF (Linux), etc.
- Opção de carregamento manual para incluir cabeçalhos e seções ocultas.

### 🎨 Modos de Visualização
- **Modo Gráfico**:  
  - Fluxo do programa com setas coloridas:  
    - 🔴 Vermelho: condição falsa  
    - 🟢 Verde: condição verdadeira  
    - 🔵 Azul: salto incondicional  
  - Setas para cima indicam loops.

- **Modo Texto**:  
  - Visualização tradicional do código desmontado.

### 🪟 Janelas Principais
| Janela | Função |
|--------|--------|
| **Funções** | Lista funções e tamanhos |
| **Strings** | Exibe strings ASCII no binário |
| **Exportação** | Funções exportadas (útil em DLLs) |
| **Nomes** | Endereços nomeados (funções, dados, strings) |
| **Importação** | Funções importadas de outras bibliotecas |
| **Estruturas** | Layout de estruturas de dados |

### 🔍 Recursos Avançados
- **Referência Cruzada (XRef)**:  
  - Mostra onde uma função/string é usada.  
  - Acesso via tecla `x` sobre o item.

- **Renomeação de Funções/Variáveis**:  
  - Permite dar nomes significativos durante a análise.

- **Busca**:  
  - Texto, sequência de bytes, opcodes.

---

## 🔁 Código em C vs Assembly

### 🧮 Operações Aritméticas
**Exemplo em C**:
```c
int x = 4;
int y = 5;
x = x + 12;
x = x - y;
y++;
x--;
```
**Assembly correspondente**:
```asm
mov dword ptr [esp+0Ch], 4   ; x = 4
mov dword ptr [esp+8], 5     ; y = 5
add dword ptr [esp+0Ch], 0Ch ; x += 12
mov eax, [esp+8]             ; copia y para eax
sub [esp+0Ch], eax           ; x -= y
add dword ptr [esp+8], 1     ; y++
sub dword ptr [esp+0Ch], 1   ; x--
```

### 🔀 Estruturas Condicionais (if-else)
**Exemplo em C**:
```c
if (y == x) {
    printf("x igual a y.");
} else {
    printf("x diferente de y.");
}
```
**Assembly**:
- `cmp`: compara valores
- `jnz` (jump if not zero): salta se forem diferentes

### 🔁 Estruturas de Repetição (for)
**Componentes**:
- Inicialização
- Comparação
- Instruções do loop
- Incremento/Decremento

**Exemplo em Assembly**:
```asm
mov dword ptr [esp+1Ch], 0   ; i = 0
jmp short loc_401539
loc_40152@:
...                           ; corpo do loop
add dword ptr [esp+1Ch], 1   ; i++
loc_401539:
cmp dword ptr [esp+1Ch], 9   ; i < 10?
jle short loc_40152@         ; salta se i <= 9
```

### 🔀 Estrutura Switch-Case
- Compara uma variável com vários casos.
- Usa `cmp` e `jz`/`jnz` para saltar para o caso correspondente.
- `default` é tratado como um salto incondicional.

---

## 🧪 Exemplo: Chamada de Função

**Código em C**:
```c
int soma(int a, int b) {
    return a + b;
}

int main() {
    int x = 2, y = 4;
    printf("Valor retornado: %d", soma(x, y));
}
```

**Assembly**:
- Parâmetros `x` e `y` são movidos para `esp+4` e `esp`.
- Chamada da função `soma` via `call`.
- Retorno em `eax` é passado para `printf`.

---

## ✅ Dicas para Análise
- **Não se perca em instruções individuais**: agrupe-as mentalmente.
- **Identifique padrões**: loops, condições, chamadas de sistema.
- **Use XRefs**: para rastrear uso de funções e strings.
- **Renomeie símbolos**: para simplificar a análise.

---

## 📚 Referências
- SIKORSKI, M. **Practical Malware Analysis**
- TANENBAUM, A.S. **Organização Estruturada de Computadores**

---

## 🎯 Próximos Tópicos
- Depuração de arquivos
- Outras ferramentas de análise (ex: Ghidra, WinDbg)
- Depuração do Kernel com WinDbg

---
